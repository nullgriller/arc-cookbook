<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recipe — Details</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1 id="pageTitle">Recipe Details</h1>
    <p class="subtitle" id="pageSubtitle"></p>
  </header>

  <main>
    <article id="detail" class="recipe-detail" aria-live="polite">
      <p>Loading recipe…</p>
    </article>

    <p><a id="backLink" href="index.html">← Back to recipes</a></p>
    <div id="status" class="status" role="status" aria-live="polite"></div>
  </main>

  <script>
      
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTkcgTI-Sr63QI8AruuEhhki1PMzF5pFV2eRw-h6PgydS6499aiTZ7iGcqaW3sppjpTZfEGCoPNN6-/pub?output=csv";

  function getIdParam() {
    const params = new URLSearchParams(window.location.search);
    const idRaw = params.get("id");
    if (idRaw === null) return null;
    const id = Number(idRaw);
    if (!Number.isInteger(id) || id < 0) return null;
    return id;
  }

  function escapeHtml(s) {
    if (s === null || s === undefined) return "";
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function parseCSV(text) {

    text = text.replace(/\r\n/g, "\n");
    const rows = [];
    let cur = "";
    let row = [];
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"' && inQuotes && next === '"') {
        cur += '"';
        i++;
      } else if (ch === '"') {
        inQuotes = !inQuotes;
      } else if (ch === ',' && !inQuotes) {
        row.push(cur);
        cur = "";
      } else if (ch === '\n' && !inQuotes) {
        row.push(cur);
        rows.push(row);
        row = [];
        cur = "";
      } else {
        cur += ch;
      }
    }

    if (cur.length > 0 || row.length > 0) {
      row.push(cur);
      rows.push(row);
    }

    const filtered = rows.filter(r => r.some(cell => cell && cell.trim().length > 0));
    if (filtered.length === 0) return [];

    const headers = filtered[0].map(h => String(h || "").trim());
    const data = filtered.slice(1).map(r => {
      const obj = {};
      for (let i = 0; i < headers.length; i++) {
        obj[headers[i]] = String(r[i] || "");
      }
      return obj;
    });
    return { headers, data };
  }

  async function loadAndRender() {
    const status = document.getElementById("status");
    const detail = document.getElementById("detail");
    const id = getIdParam();
    if (id === null) {
      detail.innerHTML = "<p>Invalid or missing recipe id in the URL.</p>";
      return;
    }

    status.textContent = "Loading recipe...";
    try {
      const resp = await fetch(SHEET_CSV_URL);
      if (!resp.ok) throw new Error("Sheet fetch failed: " + resp.status);
      const text = await resp.text();
      const parsed = parseCSV(text);
      const rows = parsed.data;

      if (!Array.isArray(rows) || rows.length === 0) {
        detail.innerHTML = "<p>No recipes found in the sheet (are you sure it's published?).</p>";
        status.textContent = "";
        return;
      }

      if (id < 0 || id >= rows.length) {
        detail.innerHTML = "<p>Recipe not found (invalid id).</p>";
        status.textContent = "";
        return;
      }

      const row = rows[id];

      function getField(names) {
        for (const k of Object.keys(row)) {
          for (const name of names) {
            if (k.trim().toLowerCase() === name.toLowerCase()) return row[k];
          }
        }
        return "";
      }

      const person = getField(["Name of the person", "name of the person", "person", "submitter"]);
      const recipeName = getField(["Name of the recipe", "name of the recipe", "recipe", "title"]);
      const ingredients = getField(["Ingredients list", "ingredients list", "ingredients"]);
      const instructions = getField(["Cooking instructions", "cooking instructions", "instructions", "steps"]);
      const allergens = getField(["Allergens", "allergen", "allergens"]);
      const story = getField(["Story or Memory behind the recipe", "story or memory behind the recipe", "story", "memory"]);

      const html = `
        <h2><strong>Submitted by:</strong> ${escapeHtml(person)}</h2>

        <h3>Ingredients</h3>
<ul>
  ${escapeHtml(ingredients)
    .split(/;|\n/) 
    .map(item => `<li>${item.trim()}</li>`)
    .join("")}
</ul>

<h3>Cooking Instructions</h3>
<ul>
  ${escapeHtml(instructions)
    .split(/;|\n/)
    .map(item => `<li>${item.trim()}</li>`)
    .join("")}
</ul>

<h3>Allergens</h3>
<ul>
  ${escapeHtml(allergens)
    .split(/;|\n/)
    .map(item => `<li>${item.trim()}</li>`)
    .join("")}
</ul>

        <h3>Story / Memory</h3>
        <p>${escapeHtml(story)}</p>
      `;

      detail.innerHTML = html;
      document.getElementById("pageTitle").textContent = recipeName || "Recipe Details";
      status.textContent = "";
    } catch (err) {
      console.error(err);
      status.textContent = "Error loading recipe. See console for details.";
      detail.innerHTML = "<p>Error loading recipe data. Make sure your Google Sheet is published to web (CSV) and the URL in recipe.html is correct.</p>";
    }
  }

  loadAndRender();
  </script>
</body>
</html>





